<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>PureClean</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="shortcut icon" type="image/png" href="assets/images/icon/favicon.ico" />
  <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/font-awesome.min.css" />
  <link rel="stylesheet" href="assets/css/themify-icons.css" />
  <link rel="stylesheet" href="assets/css/metisMenu.css" />
  <link rel="stylesheet" href="assets/css/slicknav.min.css" />
  <link rel="stylesheet" href="assets/css/jquery.toast.min.css" />
  <!-- others css -->
  <link rel="stylesheet" href="assets/css/typography.css" />
  <link rel="stylesheet" href="assets/css/default-css.css" />
  <link rel="stylesheet" href="assets/css/styles.css" />
  <link rel="stylesheet" href="assets/css/responsive.css" />
  <!-- modernizr css -->
  <script src="assets/js/vendor/modernizr-2.8.3.min.js"></script>
</head>

<body>
  <!--[if lt IE 8]>
      <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
  <!-- preloader area start -->
  <div id="preloader">
    <div class="loader"></div>
  </div>
  <!-- preloader area end -->
  <!-- page container area start -->
  <div class="page-container">
    <!-- sidebar menu area start -->
    <div class="sidebar-menu">
      <div class="sidebar-header">
        <a class="navbar-brand" href="/eccctools">
          <span><i class="wi wi-sunset"></i> EC<sup>3</sup> Tools</span>
        </a>
      </div>
      <div class="main-menu">
        <div class="menu-inner">
          <nav>
            <ul class="metismenu" id="menu">
              <li class="active">
                <a href="javascript:void(0)" aria-expanded="true"><i class="ti-desktop"></i><span>PureCloud
                    Utilities</span></a>
                <ul class="collapse">
                  <li class="active bg-secondary"><a href="recordings.html">Recordings</a></li>
                </ul>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
    <!-- sidebar menu area end -->
    <!-- main content area start -->
    <div class="main-content">
      <!-- header area start -->
      <div class="header-area">
        <div class="row align-items-center">
          <!-- nav and search button -->
          <div class="col-md-6 col-sm-8 clearfix">
            <div class="nav-btn pull-left">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
          <!-- profile info & task notification -->
          <div class="col-md-6 col-sm-4 clearfix">
            <ul class="notification-area pull-right">
              <li id="full-view"><i class="ti-fullscreen"></i></li>
              <li id="full-view-exit"><i class="ti-zoom-out"></i></li>
            </ul>
          </div>
        </div>
      </div>
      <!-- header area end -->
      <!-- page title area start -->
      <div class="page-title-area">
        <div class="row align-items-center">
          <div class="col-sm-6">
            <div class="breadcrumbs-area clearfix">
              <h4 class="page-title pull-left">PureClean</h4>
              <ul class="breadcrumbs pull-left">
                <li><a href="index.html">Home</a></li>
                <li><span class="active">PureClean</span></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <!-- page title area end -->
      <div class="main-content-inner">
        <div class="mt-5 mb-5 card card-bordered">
          <div class="card-body text-center">
            <p>Download recordings from your PureCloud organization</p>
            <p>Useful if you need to download a bunch of recordings and have them available locally</p>
            <p>
              <i>Warning: This is a <b>BETA</b> version and work is still in progress</i>
            </p>
          </div>
        </div>
        <div class="mt-5 mb-5 card card-bordered">
          <div class="card-body">
            <form id="connectionform">
              <h4 class="header-title">PureCloud Connection</h4>
              <small class="form-text text-muted">Populate all fields below then click on
                <code>Start</code></small><br />
              <div class="form-group row">
                <div class="col-4">
                  <label for="clientId">Client Id</label>
                  <input required type="text" class="form-control" required name="clientId" id="clientId"
                    placeholder="Enter your client id" value="" />
                </div>
                <div class="col-4">
                  <label for="clientSecret">Client Secret</label>
                  <input required type="password" class="form-control" required name="clientSecret" id="clientSecret"
                    placeholder="Enter your client secret" value="" />
                </div>
                <div class="col-3">
                  <label for="environment">PureCloud Environment</label>
                  <select required class="form-control" style="height: 45px" required name="environment"
                    id="environment">
                    <option value="mypurecloud.ie" selected>mypurecloud.ie (Ireland)</option>
                    <option value="mypurecloud.com">mypurecloud.com (US)</option>
                    <option value="mypurecloud.de">mypurecloud.de (Germany)</option>
                    <option value="mypurecloud.com.au">mypurecloud.com.au (Australia/New Zealand)</option>
                    <option value="mypurecloud.jp">mypurecloud.jp (Japan)</option>
                  </select>
                </div>
              </div>
              <div class="form-group row">
                <div class="col-3">
                  <label for="jobName">Job Name</label>
                  <input class="form-control" type="text" id="jobName" value="" placeholder="Your friendly job name" />
                </div>
                <div class="col-3">
                  <label for="startDate">Start Date/Time</label>
                  <input required class="form-control" type="date" id="startDate" value="2019-08-01" />
                </div>
                <div class="col-3">
                  <label for="endDate">End Date/Time</label>
                  <input required class="form-control" type="date" id="endDate" value="2019-08-08" />
                </div>
              </div>
              <div class="form-group row">
                <div class="col-3">
                  <label for="queueNames">Queue Names</label>
                  <input class="form-control" type="text" id="queueNames" value="AllAgents, Apple" />
                </div>
                <div class="col-3">
                  <label for="email">Email Address</label>
                  <input class="form-control" type="text" id="email" value="daniel.szlaski@genesys.com" />
                </div>
                <div class="col-3">
                  <label for="sasTokenInMinutes">Expiration Token in minutes</label>
                  <input class="form-control" type="text" id="sasTokenInMinutes" value="1440" />
                </div>
              </div>
              <div>
                <div id="error"><span class="text-danger"></span></div>
                <div id="success"><span class="text-success"></span></div>
                <button id="connect" data-loading-text="<i class='fa fa-circle-o-notch fa-spin'></i> Processing Request"
                  class="btn btn-primary"><i class="ti-unlock"></i> Start</button>
              </div>
            </form>
          </div>
        </div>
        <div class="mt-5 mb-5 card card-bordered" id="pureCloudObjects">
          <div class="card-body">
            <h4 class="header-title">PureCloud Recordings Jobs</h4>
            <p class="text-muted">Please wait while all jobs are being processed<p><br>
                <div class="form-group row">
                  <div class="col-2">
                    <input class="form-control" type="text" id="jobIdToMonitor" value="" />
                  </div>
                  <div class="col-3">
                    <button id="monitorJob" type="button" class="btn btn-primary btn-sm">jobId to
                      monitor</button>
                  </div>
                </div>

                <button id="refresh-all" type="button" class="btn btn-info btn-sm">
                  <span id="refresh-all-spinner" class="spinner-grow spinner-grow-sm" role="status"
                    aria-hidden="true"></span>
                  Refresh All</button>
                <div id="purecloudaccordion" class="accordion accordion-s3 mt-3">
                  <!-- Jobs -->
                  <div id="jobs"></div>
                </div>
          </div>
        </div>
     
        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
          aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                ...
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
              </div>
            </div>
          </div>
        </div>

        <!-- main content area end -->
        <!-- footer area start-->
        <footer>
          <div class="footer-area">
            <p>Â© Copyright Genesys 2019. All rights reserved.</p>
          </div>
        </footer>
        <!-- footer area end-->
      </div>
      <!-- page container area end -->
      <!-- jquery latest version -->
      <script src="assets/js/vendor/jquery-2.2.4.min.js"></script>
      <!-- bootstrap 4 js -->
      <script src="assets/js/popper.min.js"></script>
      <script src="assets/js/bootstrap.min.js"></script>
      <script src="assets/js/owl.carousel.min.js"></script>
      <script src="assets/js/metisMenu.min.js"></script>
      <script src="assets/js/jquery.slimscroll.min.js"></script>
      <script src="assets/js/jquery.slicknav.min.js"></script>

      <!-- jQuery Toast -->
      <script src="assets/js/jquery.toast.min.js"></script>
      <!-- others plugins -->
      <script src="assets/js/plugins.js"></script>
      <script src="assets/js/scripts.js"></script>
      <!-- This page's scripts -->
      <script src="assets/js/aws.js"></script>
      <script src="assets/js/notifications.js"></script>
      <script src="assets/js/sweetalert.min.js"></script>
      <script src="assets/js/jquery.validate.min.js"></script>
      <script src="assets/js/additional-methods.min.js"></script>



      <script>
        var jobs = [];
        var links = [];



        var setLoading = function (button) {
          var search = $(button);
          if (!search.data("normal-text")) {
            search.data("normal-text", search.html());
          }
          search.html(search.data("loading-text"));
        };

        var clearLoading = function (button) {
          var search = $(button);
          search.html(search.data("normal-text"));
        };

        // Init
        $("#pureCloudObjects").hide();
        $("#refresh-all").hide();
        $('#refresh-all-spinner').hide();

        $("#connectionform").validate({
          errorClass: "text-danger border border-danger",
          validClass: "",
          invalidHandler: function (event, validator) {
            var errors = validator.numberOfInvalids();
            if (errors) {
              var message = errors == 1 ? "You missed 1 field. It has been highlighted" : "You missed " + errors + " fields. They have been highlighted";
              $("#connectionform #error span").html(message);
              console.error(message);
              $("#connectionform #error").show();
            }
          }
        });


        // Connect to PureCloud Button
        $("#connect").click(() => {
          event.preventDefault();

          if ($("#connectionform").valid()) {
            setLoading("#connect"); // Stop showing spinner on Connect button

            // Clear errors
            $("#connectionform #error span").html("");
            $("#connectionform #error").hide();

            // Clear connection success
            $("#connectionform #success span").html("");
            $("#connectionform #success").hide();

            connectToPureCloud($("#clientId").val(), $("#clientSecret").val(), $("#environment").children("option:selected").val()
            )
              .then(token => {
                $("#pureCloudObjects").show();
                showMessage("Please wait while all recordings are being retrieved...");
                createRecordingJob();
              })
              .catch(error => {
                console.error(error);
                showMessage(error, true);
                clearLoading("#connect"); // Stop showing spinner on Connect button
                $("#pureCloudObjects").hide();
              });
          }
        });
        $("#pureCloudObjects").show();

        // Refresh jobs
        $("#refresh-all").click(function () {
          refreshJobs();
        });


        // monitor JobId
        $("#monitorJob").click(function () {
          let newJobid = escapeHtml($("#jobIdToMonitor").val().trim());
          console.log(`try to add new ${newJobid}`);

          var bFoundItem = false;
          if (jobs.length == 0) {
            jobs.push(newJobid);
            $("#jobIdToMonitor")[0].value = "";
            refreshJobs();
          } else {

            for (var x = 0; x < jobs.length; x++) {
              if (x == jobs.length - 1 && jobs[x] != newJobid) {
                jobs.push(newJobid);
                $("#jobIdToMonitor")[0].value = "";
                refreshJobs();
                break
              } else if (jobs[x] == newJobid) {

                bFoundItem = true;
                break;
              }
            }

          }

        });

        function escapeHtml(unsafe) {
          return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }


        function createRecordingJob() {
          createJob($("#jobName").val(), $("#environment").children("option:selected").val(), $("#clientId").val(), $("#clientSecret").val(), $("#startDate").val(), $("#endDate").val(), $("#email").val(), $("#queueNames").val(), $("#sasTokenInMinutes").val())
            .then(response => {
              console.log("Response:", response);
              console.log("Jobs:", jobs);
              if (response.id) {
                if (!jobs.includes(response.id)) {
                  jobs.push(response.id);
                  refreshJobs();
                }
              }
            })
            .catch(error => {
              console.error(error);
              alert("Error in createRecordingJob():" + error.statusText);
            })
            .finally(() => {
              clearLoading("#connect"); // Stop showing spinner on Connect button
            });
        }


        function refreshJobs() {
          $('#refresh-all-spinner').fadeIn();
          document.getElementById("refresh-all").disabled = true;
          $("#jobs").empty();

          var bFoundAtLeastOneJob = false;
          $.each(jobs, (i, jobId) => {
            if (!jobId) {
              $("#refresh-all").hide();
              $('#refresh-all-spinner').fadeOut();
              return
            }
            getJob(jobId).then((job) => {

              if (Object.keys(job).length > 0) {
                createJobCard(jobId, job);
                if (!bFoundAtLeastOneJob) {
                  $("#refresh-all").show();
                  bFoundAtLeastOneJob = true;
                }
              } else {
                createJobCard(jobId, {
                  id: jobId,
                  name: "unknown",
                  status: "unknown",
                  start: "unknown",
                  interval: {
                    from: "unknown",
                    to: "unknown"
                  },
                  executionTime: {
                    start: "unknown",
                    end: "unknown"
                  }
                });
              }


            })
              .catch((error) => {
                console.error("Error while retrieving job " + jobId + ":", error);
                $('#myModal').modal();
                alert("Error while retrieving job:" + jobId + " - " + error.statusText);
                deleteJob(jobId);
              });
          });

          $('#refresh-all-spinner').fadeOut();
          document.getElementById("refresh-all").disabled = false

        }

        function deleteJob(_jobId) {
          console.log(`try to delete jobId: ${_jobId}`);
          for (var x = 0; x < jobs.length; x++) {
            if (jobs[x] == _jobId) {
              jobs.splice(x, 1);
              refreshJobs();
            };
          };

        };

        function downloadAll(_jobId) {
          console.log(`try to download all results for JobId: ${_jobId}`);
          urls = links[_jobId];

          urls.forEach((report, index) => {
            var downloadUrl = report
            setTimeout(function () {
              var a = document.createElement('a');
              a.href = downloadUrl;
              a.setAttribute('Content-type', 'application/zip');
              a.target = '_blank';
              if ('download' in a) {
                a.download = downloadUrl;
              }

              (document.body || document.documentElement).appendChild(a);
              if (a.click) {
                a.click(); // The click method is supported by most browsers.
              }
              a.parentNode.removeChild(a);
            }, 500);

          });

        }

        function createJobCard(jobId, job) {

          console.log(`Adding card for job ${jobId}:`, job);
          let card = $("<div/>", { class: "card-mb-3" }).appendTo("#jobs");


          // Accordion Header
          let cardHeader = $("<div/>", { class: "card-header" }).appendTo(card);
          var accordionTitle = $("<a/>", { class: "", "data-toggle": "collapse", href: "#entry" + jobId }).appendTo(cardHeader);
          $("<i/>", { class: "ti-angle-right" }).appendTo(accordionTitle);

          let buttonDef = `<button type="button" class="btn btn-sm btn-outline-danger float-right" style="height:25px; , vertical-align: middle; text-align: center;box-shadow: 4px 4px 4px #999;line-height:0;" onClick=\"deleteJob('${jobId}');\"><small>delete</small></button>`;
          if (job.name && job.name != 'unknown')
            accordionTitle.append(`${job.name} (${job.status}) ${buttonDef}`)
          else if (job.name != 'unknown')
            accordionTitle.append(`${job.interval.from}-${job.interval.to} (${job.status}) ${buttonDef}`);
          else
            accordionTitle.append(`${job.id} (${job.status}) ${buttonDef}`);

          // Accordion
          let accordionDiv = $("<div/>", { id: "entry" + jobId, class: "collapse", "data-parent": "#purecloudaccordion" }).appendTo(card);
          let cardBody = $("<div/>", { class: "card-body" }).appendTo(accordionDiv);

          // Add link to conversations data

          let sTitleText = "<p class=\"form-text text-muted\">Job summary</p><table style=\"border:0;\" > <colgroup><col style=\"width:20%\"><col style=\"width:10%\"><col style=\"width:70%\"></colgroup><tr><td></td><td></td><td></td></tr>" +
            `<tr><td>job Name</td><td>&emsp;</td><td>${job.name}</td></tr>` +
            `<tr><td>jobId</td><td>&emsp;</td><td>${job.id}</td></tr>` +
            `<tr><td>interval from</td><td>&emsp;</td><td>${new Date(job.interval.from).toLocaleDateString()}</td></tr>` +
            `<tr><td>interval to</td><td>&emsp;</td><td>${new Date(job.interval.to).toLocaleDateString()}</td></tr>` +
            `<tr><td>start time</td><td>&emsp;</td><td>${job.executionTime.start}</td></tr>` +
            `<tr><td>finish time</td><td>&emsp;</td><td>${job.executionTime.end}</td></tr>` +
            `<tr><td>media zip total</td><td>&emsp;</td><td id="${job.id}_archiveSize">N/A</td></tr>` +
            '</table>';

          let sItemColor;
          if (job.status == 'completed' && !job.err) {
            sItemColor = "success"
          } else if (job.status == 'completed' && job.err) {
            sItemColor = "danger"
          } else if (job.status == 'unknown') {
            sItemColor = "danger"
          } else
            sItemColor = "primary"

          $(`<ul class=\"list-group\"><li class=\"list-group-item list-group-item-${sItemColor}\">` + sTitleText + "</li></ul></br>", {}).appendTo(cardBody);

          if (job.dataUrl) {
            $("<a/>", {}).html("Link to download metadata:&nbsp&nbsp").appendTo(cardBody);
            $("<a/>", { href: job.dataUrl, text: "download link", target: "_blank" }).appendTo(cardBody);
          }

          $("<br><br><span><h5 class=\"form-text text-muted\">Media section</h5></span><br>", {}).appendTo(cardBody);
          // Table
          let table = $("<table border=0><colgroup><col style=\"width:30%\"><col style=\"width:20%\"><col style=\"width:10%\"><col style=\"width:15%\"><col style=\"width:15%\"></colgroup>", { class: "table table-striped table-hover table-sm" }).appendTo(cardBody);

          // Table headers
          let thead = $("<thead />", {}).appendTo(table);
          let tr = $("<tr />", {}).appendTo(thead);
          $("<th />", { class: "active" }).text("Id").appendTo(tr);
          $("<th />", {}).text("Progress").appendTo(tr);
          $("<th />", {}).text("").appendTo(tr);
          $("<th />", {}).text("Download Link").appendTo(tr);
          $("<th />", {}).text("Archive Size").appendTo(tr);

          // Table body
          let tbody = $("<tbody />", { id: "recordings_" + jobId }).appendTo(table);
          let totalSize = populateTable("recordings_" + jobId, job);
          console.log(totalSize);
          $(`#${jobId}_archiveSize`).html(`${Math.round(totalSize)} MB`);
          $("<table/>", {}).appendTo(table);

          if (job.name != 'unknown' && !job.err) {
            // Download all results
            var myLinks = [];
            if (job.dataUrl)
              myLinks.push(job.dataUrl);
            $.each(job.transcodingProgress, (i, transcodingItem) => {
              if (transcodingItem.url) {
                if (transcodingItem.url.startsWith("https://")) {
                  myLinks.push(transcodingItem.url);
                }
              }
            });
            links[jobId] = myLinks;

            $(`<br/><button id=\"btnDownloadAll\"type=\"button\" class=\"btn btn-primary btn-sm\" onClick=\"downloadAll('${jobId}');\"><span class="ti-download"></span><i>&nbsp;</i>   Download all archives</button>`, {}).appendTo(cardBody);

          } else {
            $(`<br/><button id=\"btnDownloadAll\"type=\"button\" class=\"btn btn-primary btn-sm\" disabled><span class="ti-download"></span><i>&nbsp;</i>   Download all archives</button>`, {}).appendTo(cardBody);
          }

        }


        function populateTable(tableName, job) {

          console.log("Populating table for:", job);

          // Clear table
          $("#" + tableName).empty();

          // Get jobs info
          var iTotalSize = 0;

          $.each(job.transcodingProgress, (i, transcodingItem) => {
            console.log("Adding Transcoding progress item:", transcodingItem);

            // Add new ro
            var row = $("<tr />").appendTo("#" + tableName);

            // Id Column
            $("<td />", {}).text(transcodingItem.jobId).appendTo(row);

            // Progress Column

            //$("<td />", {}).text(transcodingItem.progress).appendTo(row);
            $("<td />", {}).html("<div class=\"progress \"><dv class=\"progress-bar bg-success\" role=\"progressbar\" style=\"width: " + transcodingItem.progress + "%;\" aria-valuenow=\"" + transcodingItem.progress + "\" aria-valuemin=\"0\" aria-valuemax=\"100\">" + transcodingItem.progress + "%</div></div>").appendTo(row);

            // Empty Column
            $("<td />", {}).html("&nbsp").appendTo(row);

            // Download Link Column
            var downloadLinkTd = $("<td />", {}).appendTo(row);
            if (transcodingItem.url) {
              if (transcodingItem.url.startsWith("https://")) {
                // Show download url
                $("<a/>", { href: transcodingItem.url, target: "_blank", text: "Link" }).appendTo(downloadLinkTd);
              } else {
                // Show transcoding item status
                downloadLinkTd.text(transcodingItem.url);
              }
            }
            var sArchSize = Math.round(transcodingItem.size);
            if (sArchSize == 0)
              sArchSize = `< 0 MB`
            else
              sArchSize = `${sArchSize} MB`;

            $("<td />", {}).html(sArchSize).appendTo(row);
            iTotalSize = iTotalSize + transcodingItem.size;

          });

          //$(`${job.id}_archiveSize`).text = Math.round(iTotalSize);
          return iTotalSize

        }


      </script>


</body>

</html>